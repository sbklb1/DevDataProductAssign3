#
# This is the server logic of a Shiny web application. You can run the
# application by clicking 'Run App' above.
#
#

library(shiny)
library(dplyr)

# Original Data
# Stellarium nebulae catalog
#  https://github.com/Stellarium/stellarium/blob/master/nebulae/default/catalog.txt
#
# Message the original dataset in Excel to get interesting columns.  Roughly:
#    Cleanup the header
#    Remove comment rows
#    Remove excel issues with  =-
#       Copy and transpose paste
#    Remove comment rows in middle and end
#    Remove non-interesting columns
#    Sort columns to put M first
#
# columns:
# M number (Messier Catalog)
# RA (decimal degrees)
# Dec (decimal degrees)
# B magnitude
# V magnitude
# Major axis size or radius (arcmin)
# Minor axis size (arcmin)
# Orientation angle (degrees)
# Non-Redshift distance (kpc)
# NGC number (New General Catalogue)
# Object type (G, GX, GC, OC, NB, PN, DN, RN, C+N, HA, HII, SNR, BN, EN, SA, SC, RG, CL, IG, QSO or x)
#   SNR = SuperNova Remnant
#   PN = Planetary Nebula
#   RN = reflection Nebula
#   Gx = Galaxy
#   GC = Glob Cluster
#   OC = Open Cluster
#   CL = star cloud

# load data from datafile
# or create here in file as dataframe manually

MessierID <- c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110)
RADeg <- c(83.63308,323.36258,205.54842,245.89675,229.63842,265.083,268.463,270.904,259.79908,254.28771,282.771,251.80908,250.423475,264.40063,322.49304,274.7,275.196,274.992,255.65704,270.675,271.054,279.09975,269.267,274.2,277.946,281.325,299.901579,276.13704,305.983,325.09217,10.684708,10.674271,23.4621,40.521,92.225,84.075,88.075,82.179,322.95,185.55221,101.504,83.8221,83.879,130.1,56.75,115.442,114.146,123.429,187.444992,105.6979,202.469575,351.2,198.23021,283.76387,294.99879,289.14821,283.396163,189.431654,190.509675,190.9167,185.478958,255.3025,198.955537,194.182067,169.733154,170.062608,132.825,189.86658,277.84625,280.80317,298.44371,313.36542,314.75,24.17405,301.520171,25.583117,40.669879,86.6948,81.04413,244.26004,148.888221,148.968458,204.253829,186.265597,186.350221,186.549225,187.705931,187.996733,188.916183,189.207567,188.860125,259.28079,116.125,192.72145,160.990554,161.6906,168.698754,183.451217,184.706771,185.728746,210.802429,226.623171,23.346,189.997633,161.956667,184.740083,248.13275,167.879029,179.399933,10.091979)
DecDeg <- c(22.0145,-0.82325,28.37728,-26.52575,2.08103,-32.253,-34.793,-24.378,-18.51625,-4.10031,-6.27,-1.94853,36.461319,-3.24592,12.167,-13.807,-16.172,-17.102,-26.26794,-22.972,-22.49,-23.90475,-18.985,-18.55,-19.117,-9.383,22.721042,-24.86983,38.523,-23.17986,41.26875,40.865169,30.659942,42.762,24.333,34.14,32.553,35.855,48.433,58.08294,-20.757,-5.3911,-5.27,19.667,24.117,-14.81,-14.483,-5.75,8.000411,-8.3378,47.195258,61.593,18.16817,-30.47986,-30.96475,30.18347,33.029175,11.818089,11.646931,11.552611,4.473589,-30.11236,42.029289,21.682658,13.092211,12.991289,11.8,-26.74406,-32.34808,-32.29211,18.77919,-12.53731,-12.63,15.783461,-21.922261,51.575319,-0.013289,0.014,-24.52425,-22.97608,69.065295,69.679703,-29.865761,12.886983,18.191081,12.945969,12.391123,14.420411,12.556039,13.162869,14.496319,43.13594,-23.857,41.120153,11.703611,11.819939,55.019089,14.900469,14.416489,15.822381,54.34875,55.763308,60.65,-11.623054,12.581631,47.303719,-13.05378,55.674122,53.374519,41.6853)
BMag <- c(99,99,99,8.13,7.34,4.48,3.45,99,9.36,99,6.32,8.52,99,9.55,3,6.58,6.69,7.24,8.45,99,99,7.16,6.03,99,5.29,8,7.6,8.73,7.3,99,4.36,9.03,6.27,5.37,5.31,6.09,6.19,6.69,4.66,99,4.89,99,99,3.46,99,6.33,4.42,6.11,13.21,6.27,8.96,99,8.95,9.2,8.12,8.9,9.7,10.48,11,10.3,10.18,8.55,9.31,9.36,9.6,9.65,7.6,10.26,9.32,9.76,7.91,9.95,99,9.95,10.03,12.2,9.61,8,9.21,8.7,7.89,9.3,8.22,12.09,10.2,9.83,9.59,14.33,10.73,10.26,14.63,99,6.57,8.99,10.53,10.11,11.6,10.95,10.44,10.05,8.31,10.74,7.72,8.98,10.56,9.1,9.96,10.7,10.7,8.92)
VMag <- c(8.4,6.3,6.2,5.9,6.65,4.2,3.3,6,8.42,6.4,6.3,7.68,5.8,8.32,6.3,6,6,6.9,7.47,6.3,5.9,5.1,5.5,4.6,4.6,8,7.4,7.66,6.6,7.7,3.44,8.08,5.72,5.2,5.1,6,5.6,6.4,4.6,9.65,4.5,4,9,3.1,1.2,6.1,4.4,5.8,8.3,5.9,8.1,6.9,7.7,7.7,7.42,8.4,8.8,9.66,10.6,9.8,9.65,7.39,8.59,8.52,10.25,8.92,6.9,7.3,8.31,9.06,6.1,9.2,8.9,9.39,9.18,10.1,8.87,8.3,8.56,7.87,6.94,8.41,7.54,10.49,10,8.9,8.63,13.18,9.75,9.54,13.57,6.4,6.2,8.24,9.73,9.25,9.9,10.14,9.87,9.35,7.86,9.89,7.4,8,9.76,8.41,8.85,10.7,10.6,8.07)
MajorAxis <- c(8,16,18,26,23,25,80,90,12,20,14,16,20,11,18,120,40,7,17,20,16,32,25,90,26,10,8,11.2,10,12,189.1,8.5,68.7,25,25,10,15,15,31,0,39,90,20,70,110,20,25,30,10.2,15,11.2,16,13,12,19,8.8,3.8,5.9,5.4,7.4,6.5,15,12.6,10.71,8.709,9.1,25,11,8.1,8,7.2,6.6,2.8,10.5,6.8,3.12,7.1,8,9.6,10,26.9,11.2,12.9,6.5,7.1,8.9,7.2,6.9,5.1,9.5,5.4,14,10,11.2,3.1,7.6,3.4,9.8,5.4,7.4,28.8,6.5,6,8.7,5.4,18.6,13,8.7,7.6,21.9)
MinorAxis <- c(4,0,0,0,0,0,0,40,0,0,0,0,7.91,0,0,25,30,0,0,20,0,0,0,60,0,0,5.6,0,0,0,61.7,6.5,41.6,0,0,0,0,0,0,0,0,60,15,0,110,0,0,0,8.3,0,6.9,0,0,0,0,0,2.4,4.7,3.7,6,5.8,0,7.2,5.128,2.454,4.2,0,0,0,0,0,0,0,9.5,1.942,2.307,6,6,0,0,14.1,4.3,11.5,5.6,5.5,5.8,6.8,3.7,4.7,4.4,4.3,0,0,9.1,2.9,5.2,3.3,2.8,4.7,6.3,26.9,3.1,0,3.5,4.8,7.2,0,2.2,4.7,11)
OrientationAngleDeg <- c(90,0,0,0,0,0,0,0,0,0,0,0,150,0,0,0,0,0,0,0,0,0,0,90,0,0,95,0,0,0,45,165,50,0,0,0,0,0,0,0,0,90,0,0,90,0,0,0,163,0,57,0,0,0,0,0,90,75,165,108,20,0,98,110,172,6,0,0,0,0,0,0,0,87,70,90,12,0,0,0,149,67,45,123,12,125,153,140,150,15,120,0,0,85,163,135,90,150,23,108,28,123,0,87,67,160,0,82,38,178)
NonRedshiftDistance <- c(2,12,10,2.2,7.5,0.491,0.3,1.25,7.9,4.4,1.9,4.8,7.7,9.3,10,2.146,1.686,1.5,8.8,1.6,1.3,3,0.659,3.07,0.613,1.534,0.264,5.5,4,8.3,778,763,835,0.47,0.85,1.3,1.383,1.3,0.253,0.156,0.71,0.412,0.49,0.177,0.1362,1.7,0.49,0.46,17700,1,7100,0.153,18,26.8,5.4,10,0.88,19100,18300,16800,16100,6.8,11340,7360,0,11000,0.85,10.3,9.1,9,4,16.73,0.77,9200,20.7,0.746,14400,0.49,13,10,3620,3700,4610,18400,18500,15900,18400,14410,15330,18000,19000,8.2,1.1,4910,10000,9600,0.621,34800,15400,16860,6400,17700,3,8980,9800,7000,6.4,14100,25600,824)
NGCNumber <- c(1952,7089,5272,6121,5904,6405,6475,0,6333,6254,6705,6218,6205,6402,7078,6611,6618,6613,6273,6514,6531,6656,6494,0,0,6694,6853,6626,6913,7099,224,221,598,1039,2168,1960,2099,1912,7092,0,2287,1976,1982,2632,0,2437,2422,2548,4472,2323,5194,7654,5024,6715,6809,6779,6720,4579,4621,4649,4303,6266,5055,4826,3623,3627,2682,4590,6637,6681,6838,6981,6994,628,6864,650,1068,2068,1904,6093,3031,3034,5236,4374,4382,4406,4486,4501,4552,4569,4548,6341,2447,4736,3351,3368,3587,4192,4254,4321,5457,5866,581,4594,3379,4258,6171,3556,3992,205)
ObjectTypeLong <- c("SNR", "GC", "GC", "GC", "GC", "OC", "OC", "HII", "GC", "GC", "OC", "GC", "GC", "GC", "GC", "C+N", "C+N", "OC", "GC", "C+N", "OC", "GC", "OC", "CL", "OC", "OC", "PN", "GC", "OC", "GC", "Gx", "Gx", "Gx", "OC", "OC", "OC", "OC", "OC", "OC", "x", "OC", "HII", "HII", "OC", "C+N", "OC", "OC", "OC", "Gx", "OC", "Gx", "OC", "GC", "GC", "GC", "GC", "PN", "Gx", "Gx", "Gx", "Gx", "GC", "Gx", "Gx", "Gx", "Gx", "OC", "GC", "GC", "GC", "GC", "GC", "OC", "Gx", "GC", "PN", "Gx", "RN", "GC", "GC", "Gx", "Gx", "Gx", "Gx", "Gx", "Gx", "Gx", "Gx", "Gx", "Gx", "Gx", "GC", "OC", "Gx", "Gx", "Gx", "PN", "Gx", "Gx", "Gx", "Gx", "Gx", "OC", "Gx", "Gx", "Gx", "GC", "Gx", "Gx", "Gx")
ObjectTypeRed <- c("N", "GC", "GC", "GC", "GC", "OC", "OC", "N", "GC", "GC", "OC", "GC", "GC", "GC", "GC", "N", "N", "OC", "GC", "N", "OC", "GC", "OC", "x", "OC", "OC", "N", "GC", "OC", "GC", "Gx", "Gx", "Gx", "OC", "OC", "OC", "OC", "OC", "OC", "x", "OC", "N", "N", "OC", "OC", "OC", "OC", "OC", "Gx", "OC", "Gx", "OC", "GC", "GC", "GC", "GC", "N", "Gx", "Gx", "Gx", "Gx", "GC", "Gx", "Gx", "Gx", "Gx", "OC", "GC", "GC", "GC", "GC", "GC", "OC", "Gx", "GC", "N", "Gx", "N", "GC", "GC", "Gx", "Gx", "Gx", "Gx", "Gx", "Gx", "Gx", "Gx", "Gx", "Gx", "Gx", "GC", "OC", "Gx", "Gx", "Gx", "N", "Gx", "Gx", "Gx", "Gx", "Gx", "OC", "Gx", "Gx", "Gx", "GC", "Gx", "Gx", "Gx")

messier <- data.frame(MessierID, RADeg, DecDeg, BMag, VMag, MajorAxis, MinorAxis, OrientationAngleDeg, NonRedshiftDistance, NGCNumber, ObjectTypeRed)


# Define server logic required to draw a plot
shinyServer(function(input, output) {

    model <- reactive({
        brushed_data <- brushedPoints(messier, input$brush1,
                                      xvar = "MajorAxis", yvar = "VMag")
        if(nrow(brushed_data) < 2){ return(NULL)}
        lm(VMag ~ MajorAxis, data = brushed_data)
    })
    
    output$slopeOut <- renderText({
        if(is.null(model())){
            "XX No Model Found XX"
        } else {
            model()[[1]][2]
            
        }
    })
    output$intOut <- renderText({
        if(is.null(model())){
            "XX No Model Found XX"
        } else {
            model()[[1]][1]
        }
    })
    
    # filter based on user selection of group  
    messier_subset <- reactive({
      filter(messier, ObjectTypeRed %in% input$ObjType ) 
    })

    # because subset is reactive future reference needs to be m_s()$var
    output$plot1 <- renderPlot({
        plot(messier_subset()$MajorAxis, messier_subset()$VMag, 
             xlab = "MajorAxis", ylab = "VMag", 
             main = "Messier Objects Data", 
             col = factor(messier_subset()$ObjectTypeRed),
             cex = 2, pch = 19, bty = "n")
        if (!is.null(model())){
            abline(model(), col = "blue", lwd = 3)
        }
      
       # label the points with the messier object ID
        text(messier_subset()$MajorAxis, messier_subset()$VMag, 
             labels=messier_subset()$MessierID, col="blue", 
             cex=0.9, font=2, pos=4)
    })
})
